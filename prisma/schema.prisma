generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  meetings     Meeting[]
  participants Participant[] // Agenda de contactos del usuario
}

model MediaFile {
  url         String
  filename    String
  mimeType    String?
  size        Int?
  createdAt   DateTime     @default(now())
  id          Int          @id @default(autoincrement())
  meeting     Meeting?     @relation("MeetingAudio")
  participant Participant? @relation("ParticipantVoice")
}

model Participant {
  id            String               @id @default(uuid())
  name          String
  userId        String               @map("user_id")
  createdAt     DateTime             @default(now())
  voiceSampleId Int?                 @unique
  user          User                 @relation(fields: [userId], references: [id])
  voiceSample   MediaFile?           @relation("ParticipantVoice", fields: [voiceSampleId], references: [id])
  meetings      MeetingParticipant[]

  @@index([userId])
}

model MeetingParticipant {
  meetingId     String
  participantId String
  createdAt     DateTime @default(now())

  meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@id([meetingId, participantId])
}

model Meeting {
  id              String               @id @default(uuid())
  title           String
  description     String?
  date            DateTime             @default(now())
  aiAnalysis      Json?
  transcript      Json?
  metrics         Json?
  durationSeconds Int?
  status          String               @default("PENDING")
  user_id         String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  audioFileId     Int?                 @unique
  audioFile       MediaFile?           @relation("MeetingAudio", fields: [audioFileId], references: [id])
  user            User                 @relation(fields: [user_id], references: [id])
  participants    MeetingParticipant[]
}

model MediaFileLog {
  id           BigInt   @id @default(autoincrement())
  createdAt    DateTime @default(now()) @map("created_at")
  level        String   @db.VarChar(16)
  requestId    String?  @map("request_id") @db.VarChar(64)
  method       String?  @db.VarChar(8)
  path         String?
  statusCode   Int?     @map("status_code")
  remoteIp     String?  @map("remote_ip") @db.Inet
  userAgent    String?  @map("user_agent")
  mimeType     String?  @map("mime_type")
  filename     String?
  sizeBytes    BigInt?  @map("size_bytes")
  errorCode    String?  @map("error_code")
  errorMessage String?  @map("error_message")
  stackSnippet String?  @map("stack_snippet")

  @@index([createdAt], map: "idx_ob_mediafie_logs_created_at")
  @@index([level], map: "idx_ob_mediafie_logs_level")
  @@index([statusCode], map: "idx_ob_mediafie_logs_status_code")
  @@index([requestId], map: "idx_ob_mediafie_logs_request_id")
  @@map("ob_mediafie_logs")
}
