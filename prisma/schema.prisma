generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  meetings     Meeting[]
  participants Participant[] // Agenda de contactos del usuario
}

model MediaFile {
  url         String
  filename    String
  mimeType    String?
  size        Int?
  createdAt   DateTime     @default(now())
  id          Int          @id @default(autoincrement())
  meeting     Meeting?     @relation("MeetingAudio")
  participant Participant? @relation("ParticipantVoice")
}

model ObMediaFile {
  id           BigInt   @id @default(autoincrement())
  createdAt    DateTime @default(now()) @map("created_at")
  originalName String   @map("original_name")
  storedName   String   @map("stored_name")
  subfolder    String   @db.VarChar(16)
  mimeType     String   @map("mime_type")
  sizeBytes    BigInt   @map("size_bytes")
  extension    String   @default("") @db.VarChar(16)
  relativePath String   @default("") @map("relative_path")
  diskPath     String   @default("") @map("disk_path")
  publicUrl    String   @map("public_url")
  requestId    String?  @map("request_id") @db.VarChar(64)
  remoteIp     String?  @map("remote_ip") @db.Inet
  userAgent    String?  @map("user_agent")

  @@map("ob_mediafiles")
}

model Participant {
  id            String               @id @default(uuid())
  name          String
  userId        String               @map("user_id")
  createdAt     DateTime             @default(now())
  voiceSampleId Int?                 @unique
  user          User                 @relation(fields: [userId], references: [id])
  voiceSample   MediaFile?           @relation("ParticipantVoice", fields: [voiceSampleId], references: [id])
  meetings      MeetingParticipant[]

  @@index([userId])
}

model MeetingParticipant {
  meetingId     String
  participantId String
  createdAt     DateTime @default(now())

  meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@id([meetingId, participantId])
}

model Meeting {
  id          String  @id @default(uuid())
  title       String
  description String?

  date            DateTime @default(now())
  durationSeconds Int?

  /**
   * AI OUTPUTS
   */
  aiAnalysis             Json? // JSON completo devuelto por el LLM (fuente de verdad)
  transcript             Json? // { language, segments[] }
  metrics                Json? // engagement, clarity, participationBalance
  participantsAnalysis   Json? // speaking time, dominance, inferred role
  actionItems            Json? // tareas accionables
  decisions              Json? // explicit / implicit decisions
  speakerInsights        Json? // estilos de comunicaci√≥n, dominance
  conversationDynamics   Json? // interrupciones, flow, topic shifts
  nextMeetingPreparation Json? // agenda sugerida, pendientes

  /**
   * SYSTEM
   */
  status    String   @default("PENDING")
  user_id   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * RELATIONS
   */
  audioFileId  Int?                 @unique
  audioFile    MediaFile?           @relation("MeetingAudio", fields: [audioFileId], references: [id])
  user         User                 @relation(fields: [user_id], references: [id])
  participants MeetingParticipant[]

  @@index([user_id])
  @@index([status])
}

model MediaFileLog {
  id           BigInt   @id @default(autoincrement())
  createdAt    DateTime @default(now()) @map("created_at")
  level        String   @db.VarChar(16)
  requestId    String?  @map("request_id") @db.VarChar(64)
  method       String?  @db.VarChar(8)
  path         String?
  statusCode   Int?     @map("status_code")
  remoteIp     String?  @map("remote_ip") @db.Inet
  userAgent    String?  @map("user_agent")
  mimeType     String?  @map("mime_type")
  filename     String?
  sizeBytes    BigInt?  @map("size_bytes")
  errorCode    String?  @map("error_code")
  errorMessage String?  @map("error_message")
  stackSnippet String?  @map("stack_snippet")

  @@index([createdAt], map: "idx_ob_mediafie_logs_created_at")
  @@index([level], map: "idx_ob_mediafie_logs_level")
  @@index([statusCode], map: "idx_ob_mediafie_logs_status_code")
  @@index([requestId], map: "idx_ob_mediafie_logs_request_id")
  @@map("ob_mediafie_logs")
}
